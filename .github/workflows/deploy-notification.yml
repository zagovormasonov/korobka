name: Deploy Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Wait for Render deployment
        run: |
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è –Ω–∞ Render..."
          sleep 120  # –ñ–¥—ë–º 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è
      
      - name: Check deployment status
        id: check_deploy
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://idenself.com/api/health || echo "000")
          echo "üì° HTTP —Å—Ç–∞—Ç—É—Å: $response"
          
          if [ "$response" = "200" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $response)"
          fi
      
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          
          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          
          echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
          
          if [ "${{ steps.check_deploy.outputs.status }}" = "success" ]; then
            EMOJI="‚úÖ"
            STATUS="–£—Å–ø–µ—à–Ω–æ"
            MESSAGE="üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          else
            EMOJI="‚ùå"
            STATUS="–û—à–∏–±–∫–∞"
            MESSAGE="‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ! –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_ID=$(git rev-parse --short HEAD)
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          TIME=$(TZ='Europe/Moscow' date '+%d.%m.%Y %H:%M')
          
          echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
          echo "üìã Chat ID: ${TELEGRAM_CHAT_ID}"
          echo "üìã Bot Token: ${TELEGRAM_BOT_TOKEN:0:10}..." # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="${EMOJI} <b>–î–µ–ø–ª–æ–π ${STATUS}</b>

üì¶ –°–µ—Ä–≤–∏—Å: <code>korobka-1</code>
üìù –ö–æ–º–º–∏—Ç: <code>${COMMIT_ID}</code>
üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: ${COMMIT_MSG}
üë§ –ê–≤—Ç–æ—Ä: ${COMMIT_AUTHOR}
‚è∞ –í—Ä–µ–º—è: ${TIME}

${MESSAGE}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "üì° HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: $HTTP_CODE"
          echo "üìÑ –û—Ç–≤–µ—Ç API: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

