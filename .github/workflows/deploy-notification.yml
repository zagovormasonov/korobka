name: Deploy Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Wait for Render deployment and check status
        id: check_deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è –Ω–∞ Render..."
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º Render API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–µ–ø–ª–æ—è
          SERVICE_ID="srv-d38pnk15pdvs738pmd7g"  # ID —Å–µ—Ä–≤–∏—Å–∞ korobka-1
          MAX_ATTEMPTS=120  # –ú–∞–∫—Å–∏–º—É–º 20 –º–∏–Ω—É—Ç (120 * 10 —Å–µ–∫—É–Ω–¥)
          ATTEMPT=0
          DEPLOY_SUCCESS=false
          LAST_DEPLOY_STATUS=""
          STABLE_COUNT=0
          
          # –î–∞—ë–º Render –≤—Ä–µ–º—è –Ω–∞—á–∞—Ç—å –¥–µ–ø–ª–æ–π
          echo "‚è≥ –ñ–¥—ë–º 20 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã Render –Ω–∞—á–∞–ª –¥–µ–ø–ª–æ–π..."
          sleep 20
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$DEPLOY_SUCCESS" = "false" ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "üì° –ü–æ–ø—ã—Ç–∫–∞ $ATTEMPT/$MAX_ATTEMPTS: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è..."
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Render API
            if [ -n "$RENDER_API_KEY" ]; then
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º Render API
              DEPLOY_RESPONSE=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
                "https://api.render.com/v1/services/$SERVICE_ID/deploys?limit=1" || echo "{}")
              
              DEPLOY_STATUS=$(echo "$DEPLOY_RESPONSE" | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
              
              if [ -n "$DEPLOY_STATUS" ]; then
                echo "   üìä –°—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è (Render API): $DEPLOY_STATUS"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Å—Ç–∞—Ç—É—Å
                if [ "$DEPLOY_STATUS" != "$LAST_DEPLOY_STATUS" ]; then
                  echo "   üîÑ –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è: $LAST_DEPLOY_STATUS -> $DEPLOY_STATUS"
                  LAST_DEPLOY_STATUS="$DEPLOY_STATUS"
                fi
                
                # –ï—Å–ª–∏ –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ
                if [ "$DEPLOY_STATUS" = "live" ]; then
                  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º health endpoint –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
                  echo "   üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è..."
                  sleep 5
                  HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://idenself.com/api/health || echo "000")
                  
                  if [ "$HEALTH_RESPONSE" = "200" ]; then
                    echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ! (—Å—Ç–∞—Ç—É—Å: live, health: OK)"
                    echo "status=success" >> $GITHUB_OUTPUT
                    DEPLOY_SUCCESS=true
                    break
                  else
                    echo "   ‚ö†Ô∏è –°—Ç–∞—Ç—É—Å 'live', –Ω–æ health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HEALTH_RESPONSE), –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É..."
                  fi
                elif [ "$DEPLOY_STATUS" = "build_failed" ] || [ "$DEPLOY_STATUS" = "update_failed" ]; then
                  echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: $DEPLOY_STATUS"
                  echo "status=failed" >> $GITHUB_OUTPUT
                  DEPLOY_SUCCESS=true  # –ó–∞–≤–µ—Ä—à–∞–µ–º, –Ω–æ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º failed
                  break
                else
                  echo "   ‚è≥ –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ: $DEPLOY_STATUS"
                fi
              else
                echo "   ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–∑ Render API, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback (health endpoint)..."
                # Fallback: –ø—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
                HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://idenself.com/api/health || echo "000")
                if [ "$HEALTH_RESPONSE" = "200" ]; then
                  echo "   ‚úÖ Health endpoint –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"
                fi
              fi
            else
              # Fallback: –µ—Å–ª–∏ –Ω–µ—Ç API –∫–ª—é—á–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ health endpoint
              echo "   ‚ö†Ô∏è RENDER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ health endpoint..."
              HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://idenself.com/api/health || echo "000")
              echo "   üìä Health endpoint: HTTP $HEALTH_RESPONSE"
              
              if [ "$HEALTH_RESPONSE" = "200" ]; then
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (2 —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥—Ä—è–¥)
                STABLE_COUNT=$((STABLE_COUNT + 1))
                
                if [ $STABLE_COUNT -ge 2 ]; then
                  echo "‚úÖ –°–µ—Ä–≤–∏—Å —Å—Ç–∞–±–∏–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω! –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω."
                  echo "status=success" >> $GITHUB_OUTPUT
                  DEPLOY_SUCCESS=true
                  break
                else
                  echo "   ‚úÖ Health endpoint –¥–æ—Å—Ç—É–ø–µ–Ω ($STABLE_COUNT/2), –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É..."
                fi
              else
                STABLE_COUNT=0
                echo "   ‚è≥ Health endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HEALTH_RESPONSE), –¥–µ–ø–ª–æ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ..."
              fi
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "‚è≥ –ñ–¥—ë–º 10 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π..."
              sleep 10
            fi
          done
          
          if [ "$DEPLOY_SUCCESS" = "false" ]; then
            echo "‚ùå –î–µ–ø–ª–æ–π –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ $MAX_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          
          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          
          echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
          
          if [ "${{ steps.check_deploy.outputs.status }}" = "success" ]; then
            EMOJI="‚úÖ"
            STATUS="–£—Å–ø–µ—à–Ω–æ"
            MESSAGE="üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          else
            EMOJI="‚ùå"
            STATUS="–û—à–∏–±–∫–∞"
            MESSAGE="‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ! –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_ID=$(git rev-parse --short HEAD)
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          TIME=$(TZ='Europe/Moscow' date '+%d.%m.%Y %H:%M')
          
          echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
          echo "üìã Chat ID: ${TELEGRAM_CHAT_ID}"
          echo "üìã Bot Token: ${TELEGRAM_BOT_TOKEN:0:10}..." # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ printf
          MESSAGE_TEXT=$(printf '%s <b>–î–µ–ø–ª–æ–π %s</b>\n\nüì¶ –°–µ—Ä–≤–∏—Å: <code>korobka-1</code>\nüìù –ö–æ–º–º–∏—Ç: <code>%s</code>\nüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: %s\nüë§ –ê–≤—Ç–æ—Ä: %s\n‚è∞ –í—Ä–µ–º—è: %s\n\n%s' \
            "${EMOJI}" "${STATUS}" "${COMMIT_ID}" "${COMMIT_MSG}" "${COMMIT_AUTHOR}" "${TIME}" "${MESSAGE}")
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            --data-urlencode "text=${MESSAGE_TEXT}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "üì° HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: $HTTP_CODE"
          echo "üìÑ –û—Ç–≤–µ—Ç API: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (HTTP $HTTP_CODE)"
            echo "$BODY"
            # –ù–µ –ø–∞–¥–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            echo "‚ö†Ô∏è Workflow –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
          fi
