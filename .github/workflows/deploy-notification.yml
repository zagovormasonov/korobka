name: Deploy Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Wait for Render deployment
        run: |
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è –Ω–∞ Render..."
          sleep 120  # –ñ–¥—ë–º 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è
      
      - name: Check deployment status
        id: check_deploy
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://idenself.com/api/health || echo "000")
          echo "üì° HTTP —Å—Ç–∞—Ç—É—Å: $response"
          
          if [ "$response" = "200" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $response)"
          fi
      
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ steps.check_deploy.outputs.status }}" = "success" ]; then
            EMOJI="‚úÖ"
            STATUS="–£—Å–ø–µ—à–Ω–æ"
            MESSAGE="üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          else
            EMOJI="‚ùå"
            STATUS="–û—à–∏–±–∫–∞"
            MESSAGE="‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ! –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_ID=$(git rev-parse --short HEAD)
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          TIME=$(TZ='Europe/Moscow' date '+%d.%m.%Y %H:%M')
          
          echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="${EMOJI} <b>–î–µ–ø–ª–æ–π ${STATUS}</b>

üì¶ –°–µ—Ä–≤–∏—Å: <code>korobka-1</code>
üìù –ö–æ–º–º–∏—Ç: <code>${COMMIT_ID}</code>
üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: ${COMMIT_MSG}
üë§ –ê–≤—Ç–æ—Ä: ${COMMIT_AUTHOR}
‚è∞ –í—Ä–µ–º—è: ${TIME}

${MESSAGE}"
          
          echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"

