name: Deploy Notification

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Wait for Render deployment and check status
        id: check_deploy
        run: |
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è –Ω–∞ Render..."
          echo "üîç –°—Ç—Ä–∞—Ç–µ–≥–∏—è: —Å–Ω–∞—á–∞–ª–∞ –∂–¥—ë–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–Ω–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è), –∑–∞—Ç–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–∫–æ–Ω–µ—Ü –¥–µ–ø–ª–æ—è)"
          
          MAX_ATTEMPTS=120  # –ú–∞–∫—Å–∏–º—É–º 20 –º–∏–Ω—É—Ç (120 * 10 —Å–µ–∫—É–Ω–¥)
          ATTEMPT=0
          DEPLOY_STARTED=false
          DEPLOY_SUCCESS=false
          STABLE_SUCCESS_COUNT=0
          REQUIRED_STABLE_SUCCESSES=3  # –ù—É–∂–Ω–æ 3 —É—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥—Ä—è–¥ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
          
          # –§–∞–∑–∞ 1: –ñ–¥—ë–º –Ω–∞—á–∞–ª–∞ –¥–µ–ø–ª–æ—è (—Å–µ—Ä–≤–∏—Å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º)
          echo "üìã –§–∞–∑–∞ 1: –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –¥–µ–ø–ª–æ—è (—Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º)..."
          INITIAL_WAIT=30  # –î–∞—ë–º Render 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è
          echo "‚è≥ –ñ–¥—ë–º ${INITIAL_WAIT} —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã Render –Ω–∞—á–∞–ª –¥–µ–ø–ª–æ–π..."
          sleep $INITIAL_WAIT
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$DEPLOY_STARTED" = "false" ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "üì° –ü–æ–ø—ã—Ç–∫–∞ $ATTEMPT/$MAX_ATTEMPTS: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∞–ª—Å—è –ª–∏ –¥–µ–ø–ª–æ–π..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" https://idenself.com/api/health || echo "000")
            echo "   HTTP —Å—Ç–∞—Ç—É—Å: $response"
            
            if [ "$response" != "200" ]; then
              echo "   ‚úÖ –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –¥–µ–ø–ª–æ–π –Ω–∞—á–∞–ª—Å—è!"
              DEPLOY_STARTED=true
              STABLE_SUCCESS_COUNT=0
              break
            else
              echo "   ‚è≥ –°–µ—Ä–≤–∏—Å –µ—â—ë –¥–æ—Å—Ç—É–ø–µ–Ω (—Å—Ç–∞—Ä—ã–π –¥–µ–ø–ª–æ–π), –∂–¥—ë–º –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–≥–æ..."
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep 10
            fi
          done
          
          # –ï—Å–ª–∏ –¥–µ–ø–ª–æ–π –Ω–µ –Ω–∞—á–∞–ª—Å—è –∑–∞ —Ä–∞–∑—É–º–Ω–æ–µ –≤—Ä–µ–º—è, –≤–æ–∑–º–æ–∂–Ω–æ –æ–Ω –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω
          if [ "$DEPLOY_STARTED" = "false" ]; then
            echo "‚ö†Ô∏è –î–µ–ø–ª–æ–π –Ω–µ —Å—Ç–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω."
            echo "üìã –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞..."
            DEPLOY_STARTED=true  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
          fi
          
          # –§–∞–∑–∞ 2: –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è (—Å–µ—Ä–≤–∏—Å —Å–Ω–æ–≤–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º)
          echo "üìã –§–∞–∑–∞ 2: –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–ø–ª–æ—è (—Å–µ—Ä–≤–∏—Å –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º)..."
          ATTEMPT=0  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –¥–ª—è –≤—Ç–æ—Ä–æ–π —Ñ–∞–∑—ã
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$DEPLOY_SUCCESS" = "false" ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "üì° –ü–æ–ø—ã—Ç–∫–∞ $ATTEMPT/$MAX_ATTEMPTS: –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: $STABLE_SUCCESS_COUNT/$REQUIRED_STABLE_SUCCESSES)..."
            
            response=$(curl -s -o /dev/null -w "%{http_code}" https://idenself.com/api/health || echo "000")
            echo "   HTTP —Å—Ç–∞—Ç—É—Å: $response"
            
            if [ "$response" = "200" ]; then
              STABLE_SUCCESS_COUNT=$((STABLE_SUCCESS_COUNT + 1))
              echo "   ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç ($STABLE_SUCCESS_COUNT/$REQUIRED_STABLE_SUCCESSES)"
              
              if [ $STABLE_SUCCESS_COUNT -ge $REQUIRED_STABLE_SUCCESSES ]; then
                echo "‚úÖ –°–µ—Ä–≤–∏—Å —Å—Ç–∞–±–∏–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω! –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω."
                echo "status=success" >> $GITHUB_OUTPUT
                DEPLOY_SUCCESS=true
                break
              fi
            else
              # –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —Å–Ω–æ–≤–∞ —Å—Ç–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
              if [ $STABLE_SUCCESS_COUNT -gt 0 ]; then
                echo "   ‚ö†Ô∏è –°–µ—Ä–≤–∏—Å —Å–Ω–æ–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏"
                STABLE_SUCCESS_COUNT=0
              else
                echo "   ‚è≥ –î–µ–ø–ª–æ–π –µ—â—ë –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω..."
              fi
            fi
            
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "‚è≥ –ñ–¥—ë–º 10 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π..."
              sleep 10
            fi
          done
          
          if [ "$DEPLOY_SUCCESS" = "false" ]; then
            echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ —Å—Ç–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ $MAX_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          
          if [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: TELEGRAM_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          
          echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
          
          if [ "${{ steps.check_deploy.outputs.status }}" = "success" ]; then
            EMOJI="‚úÖ"
            STATUS="–£—Å–ø–µ—à–Ω–æ"
            MESSAGE="üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          else
            EMOJI="‚ùå"
            STATUS="–û—à–∏–±–∫–∞"
            MESSAGE="‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ! –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
          fi
          
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_ID=$(git rev-parse --short HEAD)
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          TIME=$(TZ='Europe/Moscow' date '+%d.%m.%Y %H:%M')
          
          echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
          echo "üìã Chat ID: ${TELEGRAM_CHAT_ID}"
          echo "üìã Bot Token: ${TELEGRAM_BOT_TOKEN:0:10}..." # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ printf
          MESSAGE_TEXT=$(printf '%s <b>–î–µ–ø–ª–æ–π %s</b>\n\nüì¶ –°–µ—Ä–≤–∏—Å: <code>korobka-1</code>\nüìù –ö–æ–º–º–∏—Ç: <code>%s</code>\nüí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: %s\nüë§ –ê–≤—Ç–æ—Ä: %s\n‚è∞ –í—Ä–µ–º—è: %s\n\n%s' \
            "${EMOJI}" "${STATUS}" "${COMMIT_ID}" "${COMMIT_MSG}" "${COMMIT_AUTHOR}" "${TIME}" "${MESSAGE}")
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            --data-urlencode "text=${MESSAGE_TEXT}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "üì° HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: $HTTP_CODE"
          echo "üìÑ –û—Ç–≤–µ—Ç API: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (HTTP $HTTP_CODE)"
            echo "$BODY"
            # –ù–µ –ø–∞–¥–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            echo "‚ö†Ô∏è Workflow –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ"
          fi

