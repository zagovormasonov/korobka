# Настройка фоновой генерации документов

## Описание функциональности

После прохождения всех тестов система автоматически запускает фоновую генерацию трех документов:

1. **Персональный план** - создается на основе результатов всех тестов
2. **Подготовка к сеансу** - руководство для эффективной подготовки к сеансу с психологом
3. **PDF для психолога** - отчет с результатами тестирования для специалиста

## Особенности реализации

- ✅ Генерация происходит в фоновом режиме
- ✅ Пользователь может закрыть вкладку - процесс продолжится
- ✅ Документы генерируются только один раз
- ✅ Красивая анимация процесса генерации
- ✅ Автоматическое перенаправление на страницу с готовыми документами

## Установка

### 1. Применение миграции базы данных

```bash
cd server
node scripts/apply_document_generation_migration.js
```

### 2. Перезапуск сервера

```bash
# Остановите сервер и запустите заново
npm start
```

## Новые API endpoints

### Запуск фоновой генерации
```
POST /api/background-generation/start
Body: { "sessionId": "uuid" }
```

### Проверка статуса генерации
```
GET /api/background-generation/status/:sessionId
```

### Генерация PDF для психолога
```
POST /api/pdf/psychologist
Body: { "sessionId": "uuid" }
```

## Новые поля в базе данных

В таблице `primary_test_results` добавлены поля:

- `personal_plan_generated` - флаг готовности персонального плана
- `session_preparation_generated` - флаг готовности подготовки к сеансу
- `psychologist_pdf_generated` - флаг готовности PDF для психолога
- `documents_generation_started` - флаг запуска генерации
- `documents_generation_completed` - флаг завершения генерации
- `documents_generation_started_at` - время начала генерации
- `documents_generation_completed_at` - время завершения генерации
- `session_preparation_content` - содержимое подготовки к сеансу
- `psychologist_pdf_content` - содержимое PDF для психолога

## Компоненты фронтенда

### GenerationAnimation.tsx
Компонент анимации процесса генерации с:
- Прогресс-баром
- Списком шагов генерации
- Индикаторами статуса каждого документа
- Информационным сообщением

### Обновления DashboardPage.tsx
- Запуск фоновой генерации после завершения тестов
- Мониторинг статуса генерации
- Отображение анимации

### Обновления PersonalPlanPage.tsx
- Проверка статуса готовности документов
- Блокировка кнопок для неготовых документов
- Отображение статуса "готовится" для документов в процессе

## Логика работы

1. Пользователь завершает все тесты
2. Нажимает кнопку "Перейти к персональному плану"
3. Система разблокирует персональный план
4. Запускается фоновая генерация документов
5. Показывается анимация с прогрессом
6. После завершения всех документов - перенаправление на страницу персонального плана
7. На странице персонального плана отображаются готовые документы

## Мониторинг

Система проверяет статус генерации каждые 3 секунды и автоматически обновляет интерфейс. При повторном входе в личный кабинет документы уже будут готовы для скачивания.

## Обработка ошибок

- Таймаут генерации: 5 минут
- Автоматическая проверка статуса при загрузке страницы
- Graceful fallback при ошибках генерации
- Логирование всех этапов процесса
