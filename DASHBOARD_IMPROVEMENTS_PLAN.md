# План исправлений личного кабинета

## Обзор
Исправить несколько критических проблем в личном кабинете: добавить тест на ПРЛ и выгорание, исправить пол в персональном плане и всех PDF, включить кэширование Луми, изменить стиль формы логина, исправить скрытие тестов после завершения, и улучшить открытие PDF в новой вкладке.

---

## 1. Тест на ПРЛ всегда в списке рекомендованных

**Проблема:** Тест на ПРЛ должен ВСЕГДА быть в списке рекомендованных тестов, независимо от ответов.

**Решение:**
- В `server/routes/ai.js`, функция `analyzeAndRecommendTests` (строка 801):
  - После получения рекомендаций от AI, принудительно добавить тест на ПРЛ (id=1) в начало списка
  - Проверить, нет ли его уже в списке, чтобы избежать дублирования
  - Код:
    ```javascript
    // Убедимся, что тест на ПРЛ всегда в списке
    if (!recommendedTestIds.includes(1)) {
      recommendedTestIds.unshift(1); // Добавляем в начало
    }
    ```

**Файлы:**
- `server/routes/ai.js` (функция `analyzeAndRecommendTests`, после строки ~865)

---

## 2. Добавить тест на выгорание

**Проблема:** Нужно добавить новый тест на выгорание (Maslach Burnout Inventory).

**Решение:**
- Добавить в массив `allTests` в `server/routes/ai.js` (строка 802):
  ```javascript
  { id: 19, name: "Тест на выгорание", url: "https://psytests.org/stress/maslach.html" }
  ```
- Добавить в `fallbackTests` в `src/pages/DashboardPage.tsx` (строка 29):
  ```javascript
  {
    id: 19,
    name: 'Тест на выгорание',
    url: 'https://psytests.org/stress/maslach.html',
    description: 'Опросник выгорания Маслач (MBI) для оценки эмоционального истощения и профессионального выгорания'
  }
  ```

**Supabase:** Изменения не требуются.

**Файлы:**
- `server/routes/ai.js` (массив `allTests`)
- `src/pages/DashboardPage.tsx` (массив `fallbackTests`)

---

## 3. ТОП-5 психотерапевтических техник в промпте

**Проблема:** В персональном плане нужно добавить конкретные упражнения.

**Решение:**
- Добавить в `prompt.txt` новый раздел с требованием включить ТОП-5 техник:
  ```
  # ОБЯЗАТЕЛЬНОЕ ТРЕБОВАНИЕ: ТОП-5 ПРАКТИЧЕСКИХ ТЕХНИК
  
  В персональный план ОБЯЗАТЕЛЬНО включи раздел "Практические техники и упражнения" с ТОП-5 конкретными психотерапевтическими техниками/упражнениями, специально подобранными для ситуации пользователя.
  
  Для каждой техники укажи:
  1. Название техники
  2. Краткое описание (2-3 предложения)
  3. Пошаговую инструкцию выполнения
  4. Когда применять
  5. Ожидаемый эффект
  ```

**Файлы:**
- `prompt.txt`

---

## 4. Стиль формы на /lk/login как на главной

**Проблема:** Форма логина должна быть в стиле главной страницы (полупрозрачная с blur).

**Решение:**
- В `src/pages/DashboardLoginPage.tsx` изменить стили (строки 132-220):
  - Card: 
    - `backgroundColor: 'rgba(255, 255, 255, 0.25)'`
    - `backdropFilter: 'blur(10px)'`
    - `WebkitBackdropFilter: 'blur(10px)'`
    - `border: '1px solid rgba(255, 255, 255, 0.6)'`
  - Input: 
    - `backgroundColor: 'rgba(255, 255, 255, 0.9)'`
    - Добавить `backdropFilter: 'blur(5px)'`

**Файлы:**
- `src/pages/DashboardLoginPage.tsx` (стили Card и Input)

---

## 5. Включить кэширование Луми И списка тестов (КРИТИЧНО)

**Проблема:** При повторном входе сообщение Луми И список рекомендованных тестов генерируются заново через AI. Из-за этого:
- Список тестов меняется (было 5, стало 4)
- Генерация занимает время
- Пользователь видит разные тесты при каждом входе

**Решение состоит из 2 частей:**

### Часть 1: Добавить колонку в Supabase для списка тестов

**Инструкция для тебя:**
1. Открой Supabase Dashboard: https://app.supabase.com
2. Выбери свой проект
3. Перейди в "SQL Editor"
4. Выполни этот SQL:

```sql
-- Добавляем колонку для хранения списка рекомендованных тестов
ALTER TABLE primary_test_results
ADD COLUMN IF NOT EXISTS recommended_tests JSONB;

-- Добавляем комментарий
COMMENT ON COLUMN primary_test_results.recommended_tests IS 'Список рекомендованных дополнительных тестов, сгенерированный AI один раз';
```

### Часть 2: Изменить код для сохранения и загрузки из кэша

В `server/routes/ai.js`, endpoint `/mascot-message/dashboard`:

**Раскомментировать строки 354-369** (проверка кэша сообщения Луми):
- Если `lumi_dashboard_message` уже есть в базе - вернуть его
- Если `recommended_tests` уже есть в базе - вернуть их
- Не генерировать заново!

**Раскомментировать строки 410-423** (сохранение в кэш):
- Сохранить сгенерированное сообщение в `lumi_dashboard_message`
- Сохранить список тестов в `recommended_tests`

**Изменить запрос к базе** (строка 452):
- Добавить `recommended_tests` в SELECT: `.select('answers, email, personal_plan, lumi_dashboard_message, recommended_tests')`

**Файлы:**
- `server/routes/ai.js` (строки 354-369, 410-423, 452)

---

## 6. Не скрывать тесты после завершения

**Проблема:** После ввода результатов последнего теста все тесты скрываются, остается только салют.

**Что происходит СЕЙЧАС:**
1. Ты вводишь результаты последнего теста → нажимаешь "Сохранить"
2. Появляется салют 🎉 (анимация confetti)
3. ВСЕ тесты полностью исчезают с экрана
4. Остается только кнопка "Перейти к персональному плану"
5. Ты не можешь увидеть, какие тесты ты прошел

**Что должно быть:**
1. Ты вводишь результаты последнего теста → нажимаешь "Сохранить"
2. Появляется салют 🎉 (анимация confetti)
3. Тесты ОСТАЮТСЯ видимыми на экране (не исчезают!)
4. Все пройденные тесты отмечены зеленой галочкой ✓
5. Под списком тестов появляется кнопка "Перейти к персональному плану"
6. Ты можешь видеть весь список пройденных тестов

**Техническое решение:**
В файле `src/pages/DashboardPage.tsx`, строка 1656 есть условие, которое проверяет "все ли тесты завершены":

```typescript
// СЕЙЧАС (неправильно):
{!allTestsCompleted && showTests && !loadingTestResults && (
  // Здесь рендерятся все тесты
)}
```

Это условие означает: "Показывай тесты ТОЛЬКО если НЕ все тесты завершены". Когда все тесты завершены (`allTestsCompleted = true`), условие становится `false` и тесты исчезают.

Нужно убрать проверку `!allTestsCompleted`:

```typescript
// ДОЛЖНО БЫТЬ (правильно):
{showTests && !loadingTestResults && (
  // Здесь рендерятся все тесты
)}
```

Теперь тесты будут показываться всегда, когда `showTests = true`, независимо от того, завершены они или нет.

**Файлы:**
- `src/pages/DashboardPage.tsx` (строка 1656)

---

## 7. Исправить пол во ВСЕХ документах (КРИТИЧНО)

**Проблема:** В персональном плане и других PDF неправильное согласование по полу.

**Решение:**

### 7.1. Персональный план
В `server/routes/ai.js`, endpoint `/personal-plan` (строки 524-527):
```javascript
const genderAnswer = primaryAnswers.find(a => a.questionId === 1);
const userGender = genderAnswer 
  ? (genderAnswer.answer === 'male' ? 'мужской' : 'женский') 
  : 'неопределен';
```

### 7.2. Подготовка к сеансам
Уже исправлено правильно (строка 644): `(genderAnswer.answer === 'male' ? 'мужской' : 'женский')`

### 7.3. PDF для психолога
Уже исправлено правильно (строка 985): `genderAnswer.answer === 'male' ? 'мужской' : 'женский'`

**Файлы:**
- `server/routes/ai.js` (строки 524-527 для персонального плана)

---

## 8. Открытие PDF в новой вкладке

**Проблема:** На iPhone PDF открывается в той же вкладке вместо новой.

**Решение:**
- В `src/pages/DashboardPage.tsx`, функции `downloadPersonalPlan`, `downloadSessionPreparation`, `downloadPsychologistPdf`:
  - Заменить `window.open(url, '_blank')` на:
    ```typescript
    const link = document.createElement('a');
    link.href = url;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    ```

- В `src/pages/PersonalPlanPage.tsx`, функция `openPdf`:
  - Применить тот же подход

**Файлы:**
- `src/pages/DashboardPage.tsx` (3 функции download)
- `src/pages/PersonalPlanPage.tsx` (функция openPdf)

---

## Порядок выполнения

1. Исправить пол в персональном плане (КРИТИЧНО)
2. Включить кэширование Луми (КРИТИЧНО)
3. Добавить тест на ПРЛ в обязательные
4. Добавить тест на выгорание
5. Добавить ТОП-5 техник в промпт
6. Не скрывать тесты после завершения
7. Изменить стиль формы логина
8. Улучшить открытие PDF в новой вкладке
9. Собрать проект и задеплоить

---

## Тестирование

После изменений проверить:
- [ ] Тест на ПРЛ всегда в списке рекомендованных
- [ ] Тест на выгорание доступен
- [ ] Пол правильно определяется во ВСЕХ документах
- [ ] Сообщение Луми не генерируется повторно
- [ ] Тесты остаются видимыми после завершения
- [ ] Форма логина полупрозрачная
- [ ] PDF открывается в новой вкладке на iPhone

